=========================================
FOLDER STRUCTURE
=========================================

garage-door/
├── dto/
    ├── garage-door-service-item.dto.ts
    ├── garage-door-spring-calculation.dto.ts
├── entity/
    ├── garage-door-item.entity.ts
├── enum/
    ├── spring-type.enum.ts
├── garage-door.module.ts
├── garage-door.resolver.ts
├── garage-door.service.ts

=========================================
FILE PATHS
=========================================

dto/garage-door-service-item.dto.ts
dto/garage-door-spring-calculation.dto.ts
entity/garage-door-item.entity.ts
enum/spring-type.enum.ts
garage-door.module.ts
garage-door.resolver.ts
garage-door.service.ts

=========================================
FILE CONTENTS
=========================================

--- FILE: dto/garage-door-service-item.dto.ts ---
import { Field, InputType } from "@nestjs/graphql";

@InputType()
export class GarageDoorServiceItemDto {
  @Field(() => String)
  item_id: string; // Maps to GarageDoorItem.id (UUID)

  @Field(() => Number, { defaultValue: 1 })
  quantity: number;
}

--- END OF FILE ---

--- FILE: dto/garage-door-spring-calculation.dto.ts ---
import { Field, Float, InputType, ObjectType } from "@nestjs/graphql";
import { SpringType } from "../enum/spring-type.enum";

@InputType()
export class GarageDoorSpringCalculationDto {
  @Field(() => Float)
  length: number;

  @Field(() => Float)
  wire_size: number;

  @Field(() => Float)
  inner_diameter: number;

  @Field(() => Boolean, { defaultValue: false })
  with_installation: boolean;

  @Field(() => SpringType, { defaultValue: SpringType.LEFT })
  spring_type: SpringType;

  @Field(() => Number, { defaultValue: 1 })
  quantity: number;

  @Field(() => String, { nullable: true })
  notes?: string;
}

@ObjectType()
export class SpringCalculationResult {
  @Field(() => Float)
  length: number;

  @Field(() => Float)
  wire_size: number;

  @Field(() => Float)
  inner_diameter: number;

  @Field(() => Boolean)
  with_installation: boolean;

  @Field(() => SpringType)
  spring_type: SpringType;

  @Field(() => Number)
  quantity: number;

  @Field(() => Float)
  calculated_price: number;

  @Field(() => String)
  display_name: string;

  @Field(() => String, { nullable: true })
  notes?: string;
}

--- END OF FILE ---

--- FILE: entity/garage-door-item.entity.ts ---
import { Field, ObjectType } from "@nestjs/graphql";
import { BaseEntity } from "@tech-slk/nest-crud";
import { Column, Entity, JoinColumn, ManyToOne } from "typeorm";
import { PriceCatalog } from "src/payment/pricing/entity/price-catalog.entity";

@Entity("garage_door_item")
@ObjectType()
export class GarageDoorItem extends BaseEntity {
  @Field(() => String)
  @Column()
  name: string;

  @Field(() => String)
  @Column()
  type: string; // maintenance, service_plan, installation, opener, rail, accessory

  @Field(() => String, { nullable: true })
  @Column({ nullable: true })
  category?: string; // Belt Drive, Chain Drive, Wall Mount, etc.

  // HYBRID APPROACH: Direct relation to PriceCatalog for static pricing
  @Field(() => String, { nullable: true })
  @Column({ nullable: true })
  price_catalog_id?: string;

  @Field(() => PriceCatalog, { nullable: true })
  @ManyToOne(() => PriceCatalog, { eager: true, nullable: true })
  @JoinColumn({ name: "price_catalog_id" })
  price_catalog?: PriceCatalog;

  @Field(() => [String], { nullable: true })
  @Column("simple-json", { nullable: true })
  includes?: string[]; // For service plans

  @Field(() => [String], { nullable: true })
  @Column("simple-json", { nullable: true })
  compatible_with?: string[];

  @Field(() => Boolean, { defaultValue: true })
  @Column({ default: true })
  is_active: boolean;

  @Field(() => String, { nullable: true })
  @Column({ nullable: true })
  image_url: string;

  @Field(() => String, { nullable: true })
  @Column({ nullable: true })
  description?: string;

  // Helper method to get price
  getPrice(): number | null {
    return this.price_catalog?.price || null;
  }
}

--- END OF FILE ---

--- FILE: enum/spring-type.enum.ts ---
import { registerEnumType } from "@nestjs/graphql";

export enum SpringType {
  LEFT = "LEFT",
  RIGHT = "RIGHT",
  BOTH = "BOTH",
}

registerEnumType(SpringType, {
  name: "SpringType",
  description: "Type of garage door spring configuration",
});

--- END OF FILE ---

--- FILE: garage-door.module.ts ---
import { Module } from "@nestjs/common";
import { TypeOrmModule } from "@nestjs/typeorm";
import { GarageDoorService } from "./garage-door.service";
import { GarageDoorResolver } from "./garage-door.resolver";
import { GarageDoorItem } from "./entity/garage-door-item.entity";
import { PricingModule } from "src/payment/pricing/pricing.module";

@Module({
  imports: [
    TypeOrmModule.forFeature([GarageDoorItem]),
    PricingModule, // For PriceCatalog access
  ],
  providers: [GarageDoorService, GarageDoorResolver],
  exports: [GarageDoorService],
})
export class GarageDoorModule {}

--- END OF FILE ---

--- FILE: garage-door.resolver.ts ---
import { Args, Mutation, Query, Resolver } from "@nestjs/graphql";
import { GarageDoorService } from "./garage-door.service";
import { GarageDoorItem } from "./entity/garage-door-item.entity";
import {
  GarageDoorSpringCalculationDto,
  SpringCalculationResult,
} from "./dto/garage-door-spring-calculation.dto";

@Resolver(() => GarageDoorItem)
export class GarageDoorResolver {
  constructor(private readonly garageDoorService: GarageDoorService) { }

  @Query(() => [GarageDoorItem])
  async getAllGarageDoorServices(): Promise<GarageDoorItem[]> {
    return this.garageDoorService.getAllServices();
  }

  @Query(() => [GarageDoorItem])
  async getGarageDoorServicesByType(
    @Args("type") type: string
  ): Promise<GarageDoorItem[]> {
    return this.garageDoorService.getServicesByType(type);
  }

  @Query(() => SpringCalculationResult)
  async calculateSpringPrice(
    @Args("input") input: GarageDoorSpringCalculationDto
  ): Promise<SpringCalculationResult> {
    return this.garageDoorService.calculateSpringPrice(input);
  }

  @Mutation(() => String)
  async seedGarageDoorServices(): Promise<string> {
    await this.garageDoorService.seedServices();
    return "Garage door services seeded successfully";
  }
}

--- END OF FILE ---

--- FILE: garage-door.service.ts ---
import { Injectable, NotFoundException } from "@nestjs/common";
import { InjectRepository } from "@nestjs/typeorm";
import { In, Repository } from "typeorm";
import { GarageDoorItem } from "./entity/garage-door-item.entity";
import {
  GarageDoorSpringCalculationDto,
  SpringCalculationResult,
} from "./dto/garage-door-spring-calculation.dto";
import { PriceCatalog } from "src/payment/pricing/entity/price-catalog.entity";
import { GarageDoorServiceItemDto } from "./dto/garage-door-service-item.dto";
import { SpringType } from "./enum/spring-type.enum";

@Injectable()
export class GarageDoorService {
  private static readonly LABOR_COST = 65; // Fixed $65 labor cost

  constructor(
    @InjectRepository(GarageDoorItem)
    private readonly garageDoorItemRepository: Repository<GarageDoorItem>,
    @InjectRepository(PriceCatalog)
    private readonly priceCatalogRepository: Repository<PriceCatalog>
  ) { }

  // Get all available services
  async getAllServices(): Promise<GarageDoorItem[]> {
    return this.garageDoorItemRepository.find({
      where: { is_active: true },
      relations: ["price_catalog"],
      order: { type: "ASC", name: "ASC" },
    });
  }

  // Get services by IDs (for order processing)
  async getServicesByIds(itemIds: string[]): Promise<GarageDoorItem[]> {
    return this.garageDoorItemRepository.find({
      where: {
        id: In(itemIds),
        is_active: true,
      },
      relations: ["price_catalog"],
    });
  }

  // Get services by type
  async getServicesByType(type: string): Promise<GarageDoorItem[]> {
    return this.garageDoorItemRepository.find({
      where: { type, is_active: true },
      relations: ["price_catalog"],
      order: { name: "ASC" },
    });
  }

  // Calculate spring price using hardcoded formula
  calculateSpringPrice(
    input: GarageDoorSpringCalculationDto
  ): SpringCalculationResult {
    const { length, wire_size, inner_diameter, with_installation, spring_type, quantity, notes } = input;

    // Base price calculation
    let basePrice = 0;

    // Simple pricing logic - adjust as needed
    basePrice += length * 2; // $2 per inch of length
    basePrice += wire_size * 50; // $50 per wire size unit
    basePrice += inner_diameter * 10; // $10 per inch of inner diameter

    // Apply multiplier based on spring type
    let springMultiplier = 1;
    let springTypeLabel = "";

    switch (spring_type) {
      case SpringType.LEFT:
        springMultiplier = 1;
        springTypeLabel = "Left";
        break;
      case SpringType.RIGHT:
        springMultiplier = 1;
        springTypeLabel = "Right";
        break;
      case SpringType.BOTH:
        springMultiplier = 1.8; // Pair discount (less than 2x)
        springTypeLabel = "Both (Pair)";
        break;
    }

    basePrice *= springMultiplier;

    // Add installation cost if requested
    if (with_installation) {
      basePrice += 95; // Installation fee
      if (spring_type === SpringType.BOTH) {
        basePrice += 95;
      }
    }

    // Apply quantity
    const calculated_price = basePrice * quantity;

    // Generate display name that includes spring type
    const installText = with_installation ? " with Installation" : "";
    const display_name = `Custom Spring ${springTypeLabel} (${length}" L, ${wire_size}" Wire, ${inner_diameter}")${installText}`;

    return {
      length,
      wire_size,
      inner_diameter,
      with_installation,
      spring_type,
      quantity,
      calculated_price,
      display_name,
      notes,
    };
  }

  // Validate service items exist and have prices
  async validateServiceItems(items: GarageDoorServiceItemDto[]): Promise<void> {
    const itemIds = items.map((item) => item.item_id);
    const services = await this.getServicesByIds(itemIds);

    const foundIds = services.map((s) => s.id);
    const missingIds = itemIds.filter((id) => !foundIds.includes(id));

    if (missingIds.length > 0) {
      throw new NotFoundException(
        `Services not found: ${missingIds.join(", ")}`
      );
    }
  }

  // Seed initial data (call this once to populate your database)
  async seedServices(): Promise<void> {
    const services = [
      // Services
      { name: "Door Adjustment", type: "maintenance", price: 129 },
      { name: "Sensor Realignment", type: "maintenance", price: 99 },
      {
        name: "Steel Door Back on Tracks (Single Door)",
        type: "maintenance",
        price: 139,
      },
      {
        name: "Steel Door Back on Tracks (Double Door)",
        type: "maintenance",
        price: 250,
      },
      {
        name: "Wooden Door Back on Tracks (Single Door)",
        type: "maintenance",
        price: 249,
      },
      {
        name: "Wooden Door Back on Tracks (Double Door)",
        type: "maintenance",
        price: 449,
      },
      { name: "Lubrication (Single Door)", type: "maintenance", price: 50 },
      { name: "Lubrication (Double Door)", type: "maintenance", price: 95 },
      { name: "Programming of Opener/Remote", type: "maintenance", price: 99 },

      // Service Plans
      {
        name: "1 Car Garage Door - Season Checking",
        type: "service_plan",
        price: 154,
      },
      {
        name: "1 Car Garage Door - Service Plan #1",
        type: "service_plan",
        price: 250,
        includes: [
          "10 rollers",
          "new cables",
          "new pulleys",
          "lubrication",
          "tune up",
        ],
      },
      {
        name: "1 Car Garage Door - Service Plan #2",
        type: "service_plan",
        price: 450,
        includes: [
          "10 rollers",
          "new cables",
          "new pulleys",
          "new springs",
          "lubrication",
          "tune up",
        ],
      },
      {
        name: "1 Car Garage Door - Service Plan #3",
        type: "service_plan",
        price: 550,
        includes: [
          "10 rollers",
          "new cables",
          "new pulleys",
          "new springs",
          "new drums",
          "new brackets",
          "lubrication",
          "tune up",
        ],
      },
      {
        name: "2 Car Garage Door - Season Checking",
        type: "service_plan",
        price: 218,
      },
      {
        name: "2 Car Garage Door - Service Plan #1 'To Spring to Life'",
        type: "service_plan",
        price: 450,
        includes: [
          "10 rollers",
          "new cables",
          "new pulleys",
          "lubrication",
          "tune up",
        ],
      },
      {
        name: "2 Car Garage Door - Service Plan #2 'A Breath of Fresh Air'",
        type: "service_plan",
        price: 650,
        includes: [
          "10 rollers",
          "new cables",
          "new pulleys",
          "new springs",
          "lubrication",
          "tune up",
        ],
      },
      {
        name: "2 Car Garage Door - Service Plan #3 'Make Your Doors Great Again'",
        type: "service_plan",
        price: 750,
        includes: [
          "10 rollers",
          "new cables",
          "new pulleys",
          "new springs",
          "new drums",
          "new brackets",
          "lubrication",
          "tune up",
        ],
      },

      // Openers
      {
        name: "Belt Drive 81550",
        category: "Belt Drive",
        type: "opener",
        price: 370,
        image_url: 'https://keyapp.s3.us-east-2.amazonaws.com/openers/opener-81550.png',
        description: '<div><h2>½ HP AC Belt Drive Wi-Fi Garage Door Opener</h2><ul><li>Built-in Wi-Fi® allows for smartphone control with the myQ® app.</li><li>Next generation garage technology: improved Wi-Fi connectivity and enhanced memory to support new myQ features and solutions.</li><li>Integrated Bluetooth technology: reduces setup time and makes it even easier to connect to the myQ app, other myQ devices and smart home technology solutions.</li><li>Standard belt drive with AC motor.</li><li>Works with Amazon Key: Enables convenient and secure In-Garage Delivery.</li><li>myQ Diagnostics in the myQ app provides real-time insights for your garage door via the Health Report. Receive alerts and error codes in the app if an issue arises and connect with a professional for services if needed.</li></ul></div>'
      },
      {
        name: "Belt Drive 84505R",
        category: "Belt Drive",
        type: "opener",
        price: 540,
        image_url: 'https://keyapp.s3.us-east-2.amazonaws.com/openers/opener-84505R.png',
        description: '<div><h2>Secure View™ Ultra-Quiet Belt Drive Smart Opener with Camera and Dual LED Lighting</h2><ul><li>Built-in camera adds video and 2-way audio communication to the myQ® app.</li><li>Control, secure and monitor the garage with the myQ app - anytime, from anywhere.</li><li>Integrated LED lighting system brightens high traffic areas of the garage with 1500 lumens of light.</li><li>Ultra-quiet DC motor and strong belt drive system ensures comfortable living spaces near the garage.</li><li>Works with Amazon Key for convenient and secure In-Garage Delivery of Amazon packages and groceries – watch deliveries happen in real-time.</li><li>myQ Diagnostics in the myQ app provides real-time insights for your garage door via the Health Report. Receive alerts and error codes in the app if an issue arises and connect with a professional for services if needed.</li></ul></div>'
      },
      {
        name: "Chain Drive 81650",
        category: "Chain Drive",
        type: "opener",
        price: 330,
        image_url: 'https://keyapp.s3.us-east-2.amazonaws.com/openers/opener-81650.png',
        description: '<div><h2>½ HP AC Chain Drive Wi-Fi Garage Door Opener</h2><ul><li>Built-in Wi-Fi® allows for smartphone control with the myQ® app.</li><li>Industrial-strength chain drive.</li><li>Works with Amazon Key: Enables convenient and secure In-Garage Delivery.</li><li>myQ Diagnostics in the myQ app provides real-time insights for your garage door via the Health Report. Receive alerts and error codes in the app if an issue arises and connect with a professional for services if needed.</li></ul></div>'
      },
      {
        name: "Chain Drive 84504R",
        category: "Chain Drive",
        type: "opener",
        price: 510,
        image_url: 'https://keyapp.s3.us-east-2.amazonaws.com/openers/opener-84504.png',
        description: '<div><h2>Secure View™ Ultra-Quiet, Belt Drive, Smart Opener with Camera, Dual LED Lighting™ and Battery Backup</h2><ul><li>Built-in Wi-Fi® allows for smartphone control with the myQ® app.</li><li>Control, secure and monitor the garage with the myQ app- anytime, from anywhere.</li><li>Battery Backup allows you to open/close your door even when the power is out.</li><li>Integrated LED lighting system brightens high traffic areas of the garage with 1500 lumens of light.</li><li>Ultra-quiet DC motor and strong belt drive system ensures for comfortable living spaces near the garage.</li><li>Works with Amazon Key: Enables convenient and secure In-Garage Delivery.</li></ul></div>'
      },
      {
        name: "Wall Mount 98022",
        category: "Wall Mount",
        type: "opener",
        price: 1211,
        image_url: 'https://keyapp.s3.us-east-2.amazonaws.com/openers/opener-98022.png',
        description: '<div><h2>Elite Series DC Battery Backup Wall Mount Wi-Fi Garage Door Opener</h2><ul><li>No cable tension monitor means easier installation.</li><li>Sleek and modern design frees up space in the garage.</li><li>Fast, smooth operation – even for tall and heavy doors. Nearly silent and vibration-free.</li><li>Remote LED lighting gives full garage light coverage. Ability to add up to sixteen 827LM remote work lights.</li><li>Battery backup ensures access in the case of power loss.</li></ul></div>'
      },

      // Rails
      {
        name: "7ft Rail",
        type: "rail",
        price: 125,
        compatible_with: ["belt_drive", "chain_drive"],
      },
      {
        name: "8ft Rail",
        type: "rail",
        price: 150,
        compatible_with: ["belt_drive", "chain_drive"],
      },
      {
        name: "10ft Rail",
        type: "rail",
        price: 200,
        compatible_with: ["belt_drive", "chain_drive"],
      },

      // Installation
      { name: "Opener Installation", type: "installation", price: 150 },
      { name: "Rail Installation", type: "installation", price: 95 },
      { name: "Door Installation (1 Car)", type: "installation", price: 450 },
      { name: "Door Installation (2 Car)", type: "installation", price: 650 },
      {
        name: "Opener Installation (Wall Mount)",
        type: "installation",
        price: 200,
        compatible_with: ["wall_mount"],
      },

      // Accessories
      { name: "Keypad", type: "accessory", price: 95 },
      { name: "Additional Remote", type: "accessory", price: 95 },
    ];

    for (const serviceData of services) {
      // Check if item already exists by name and type to avoid duplicates
      const existing = await this.garageDoorItemRepository.findOne({
        where: {
          name: serviceData.name,
          type: serviceData.type,
        },
      });

      if (!existing) {
        // Create price catalog entry if price is provided
        let priceCatalogId = null;
        if (serviceData.price !== null) {
          const priceCatalog = await this.priceCatalogRepository.save({
            name: `garage_door_${serviceData.name
              .toLowerCase()
              .replace(/[^a-z0-9]/g, "_")}`,
            price: serviceData.price,
          });
          priceCatalogId = priceCatalog.id;
        }

        // Create garage door item
        await this.garageDoorItemRepository.save({
          ...serviceData,
          price_catalog_id: priceCatalogId,
        });
      }
    }
  }
}

--- END OF FILE ---


